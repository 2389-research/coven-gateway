{"name": "agent-identity-disabled-mode", "description": "Unknown SSH keys are rejected when auto-registration is disabled (default)", "given": "Gateway running with agent_auto_registration unset or 'disabled', fresh database", "when": "Agent connects with SSH key not in principals table", "then": "Connection rejected with 'unknown public key' error", "validates": ["secure default behavior", "SSH auth flow", "principal lookup"]}
{"name": "agent-identity-approved-mode", "description": "Unknown SSH keys are auto-registered and connected when mode is 'approved'", "given": "Gateway running with agent_auto_registration='approved', fresh database", "when": "Agent connects with SSH key not in principals table", "then": "Principal auto-created with 'approved' status, agent connects successfully, receives 12-char instance ID", "validates": ["auto-registration flow", "principal creation", "instance ID generation", "display name format"]}
{"name": "agent-identity-pending-mode", "description": "Unknown SSH keys are auto-registered with pending status when mode is 'pending'", "given": "Gateway running with agent_auto_registration='pending', fresh database", "when": "Agent connects with SSH key not in principals table", "then": "Principal auto-created with 'pending' status, connection rejected with 'admin approval required' message", "validates": ["pending mode flow", "principal status", "error messaging"]}
{"name": "bind-via-instance-id", "description": "Bind channel to agent using instance ID, verify binding, delete binding", "given": "Gateway running with agent_auto_registration='approved', agent online with instance_id", "when": "POST /api/bindings with instance_id, GET /api/bindings, DELETE /api/bindings", "then": "Binding created with principal_id + working_dir, binding queryable by frontend+channel_id, binding removed on DELETE with 404 after", "validates": ["instance lookup", "binding creation", "binding query", "binding deletion", "idempotent rebind"]}
{"name": "binding-offline-agent-status", "description": "Binding correctly reports agent online/offline status", "given": "Gateway running, binding exists for agent", "when": "Agent connects then disconnects, GET /api/bindings queries status", "then": "online=true while connected, online=false after disconnect, list shows agent_online accurately", "validates": ["GetByPrincipalAndWorkDir lookup", "online status tracking", "binding status endpoint", "binding list endpoint"]}
{"name": "binding-api-validation", "description": "Binding API validates required parameters", "given": "Gateway running with authenticated client", "when": "POST /api/bindings with missing frontend/channel_id/instance_id", "then": "Returns 400 Bad Request with appropriate error message for each missing field", "validates": ["input validation", "error responses", "API contract"]}
{"name": "binding-idempotent-rebind", "description": "Rebinding same agent to same channel is idempotent", "given": "Gateway running, binding exists for channelâ†’agent", "when": "POST /api/bindings with same frontend/channel_id/instance_id", "then": "Returns 200 OK (not 201), binding_id unchanged, rebound_from is null", "validates": ["idempotent rebind", "HTTP status codes", "rebound tracking"]}
