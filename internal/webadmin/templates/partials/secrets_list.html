{{/* ABOUTME: HTMX partial for secrets table */}}
{{/* ABOUTME: Displays global and agent-specific secrets with masked values */}}
<div class="overflow-x-auto">
    <table class="min-w-full">
        <thead class="bg-warm-50 border-b border-warm-200">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-warm-500 uppercase tracking-wider">Key</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-warm-500 uppercase tracking-wider">Value</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-warm-500 uppercase tracking-wider">Scope</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-warm-500 uppercase tracking-wider">Updated</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-warm-500 uppercase tracking-wider">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-warm-100">
            {{if .Secrets}}
            {{range .Secrets}}
            <tr id="secret-{{.ID}}" class="hover:bg-warm-50 transition-colors">
                <td class="px-4 py-3">
                    <p class="text-sm font-mono font-medium text-ink">{{.Key}}</p>
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <span class="secret-value text-sm font-mono text-warm-400" data-id="{{.ID}}">••••••••</span>
                        <button type="button" onclick="toggleSecretValue(this, '{{.ID}}')"
                            class="p-1 text-warm-400 hover:text-forest transition-colors" title="Show/hide value">
                            <svg class="w-4 h-4 eye-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <svg class="w-4 h-4 eye-off-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                            </svg>
                        </button>
                    </div>
                </td>
                <td class="px-4 py-3">
                    {{if .AgentID}}
                    <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-info/10 text-info">
                        {{.AgentName}}
                    </span>
                    {{else}}
                    <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-forest/10 text-forest">
                        Global
                    </span>
                    {{end}}
                </td>
                <td class="px-4 py-3 text-sm text-warm-500">
                    {{.UpdatedAt.Format "Jan 02 15:04"}}
                </td>
                <td class="px-4 py-3">
                    <div class="flex gap-2">
                        <button hx-delete="/admin/secrets/{{.ID}}" hx-target="#secret-{{.ID}}" hx-swap="outerHTML"
                            hx-confirm="Delete secret {{.Key}}?"
                            class="px-3 py-1.5 text-xs font-medium bg-transparent text-warm-400 border border-warm-200 rounded-lg hover:border-danger hover:text-danger transition-colors">
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            {{end}}
            {{else}}
            <tr>
                <td colspan="5" class="px-4 py-16 text-center">
                    <div class="flex flex-col items-center text-warm-400">
                        <svg class="w-16 h-16 mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        <p class="text-sm font-medium">No secrets configured</p>
                        <p class="text-xs text-warm-300 mt-1">Add a secret above to get started</p>
                    </div>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<script>
async function toggleSecretValue(button, secretId) {
    const container = button.closest('td');
    const valueSpan = container.querySelector('.secret-value');
    const eyeIcon = button.querySelector('.eye-icon');
    const eyeOffIcon = button.querySelector('.eye-off-icon');

    if (valueSpan.textContent === '••••••••') {
        // Fetch value from server
        try {
            const response = await fetch('/admin/secrets/' + secretId + '/value', {
                headers: {
                    'X-CSRF-Token': document.querySelector('[hx-headers]')?.getAttribute('hx-headers')?.match(/"X-CSRF-Token":\s*"([^"]+)"/)?.[1] || ''
                }
            });
            if (response.ok) {
                const data = await response.json();
                valueSpan.textContent = data.value;
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            }
        } catch (e) {
            console.error('Failed to fetch secret value:', e);
        }
    } else {
        valueSpan.textContent = '••••••••';
        eyeIcon.classList.remove('hidden');
        eyeOffIcon.classList.add('hidden');
    }
}
</script>
