{{/* ABOUTME: Main chat application shell with sidebar and content area */}}
{{/* ABOUTME: Chat-centric redesign inspired by ChatGPT/Claude.ai UX */}}
{{define "content"}}
<div class="chat-app" hx-headers='{"X-CSRF-Token": "{{.CSRFToken}}"}'>
    <!-- Header -->
    <header class="chat-header">
        <div class="flex items-center gap-4">
            <!-- Mobile menu toggle -->
            <button id="sidebar-toggle" class="lg:hidden p-2 text-warm-500 hover:text-forest rounded-lg hover:bg-warm-100" aria-label="Toggle sidebar">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <!-- Logo -->
            <a href="/" class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-forest flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                </div>
                <span class="font-serif text-xl text-ink hidden sm:block">Coven</span>
            </a>
        </div>

        <!-- Right side: Admin link + settings -->
        <div class="flex items-center gap-2">
            <a href="/admin/" class="p-2 text-warm-400 hover:text-forest rounded-lg hover:bg-warm-100" title="Admin">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                </svg>
            </a>
            <button id="settings-btn" class="p-2 text-warm-400 hover:text-forest rounded-lg hover:bg-warm-100" title="Settings">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="chat-sidebar">
        <div class="sidebar-content">
            <!-- New Chat Button (only shown when agents are connected) -->
            {{if gt .AgentCount 0}}
            <button id="new-chat-btn" class="new-chat-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/>
                </svg>
                <span>New Chat</span>
            </button>
            {{end}}

            <!-- Thread List -->
            <div id="thread-list" class="thread-list" hx-get="/threads/list" hx-trigger="load" hx-swap="innerHTML">
                <div class="flex items-center justify-center py-8">
                    <div class="flex items-center gap-2 text-warm-400">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span class="text-xs">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Footer: Settings shortcuts -->
        <div class="sidebar-footer">
            <button class="sidebar-nav-link" data-settings-tab="agents">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span>Agents</span>
            </button>
            <button class="sidebar-nav-link" data-settings-tab="tools">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                </svg>
                <span>Tools</span>
            </button>
            <button class="sidebar-nav-link" data-settings-tab="security">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                <span>Security</span>
            </button>
            <button class="sidebar-nav-link" data-settings-tab="help">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Help</span>
            </button>
        </div>
    </aside>

    <!-- Mobile sidebar overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Main Content -->
    <main id="chat-content" class="chat-content">
        {{if .ActiveThread}}
        {{template "chat_view" .}}
        {{else}}
        {{template "empty_state" .}}
        {{end}}
    </main>

    <!-- Agent Picker Modal -->
    <div id="agent-picker-modal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="font-serif text-lg text-ink">Select an Agent</h3>
                <button id="close-agent-picker" class="p-1 text-warm-400 hover:text-ink rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="agent-list" hx-get="/agents/picker" hx-trigger="load" hx-swap="innerHTML">
                <div class="flex items-center justify-center py-8">
                    <div class="flex items-center gap-2 text-warm-400">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span class="text-xs">Loading agents...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal (Cmd+K) -->
    <div id="search-modal" class="modal-overlay hidden">
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg class="w-5 h-5 text-warm-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="search-input" placeholder="Search conversations..." class="search-input" autocomplete="off">
                <kbd class="search-kbd">esc</kbd>
            </div>
            <div id="search-results" class="search-results">
                <p class="text-sm text-warm-400 text-center py-8">Type to search threads...</p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="settings-container">
            <div class="settings-header">
                <h2 class="font-serif text-xl text-ink">Settings</h2>
                <button id="close-settings" class="p-1 text-warm-400 hover:text-ink rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="settings-body">
                <nav class="settings-nav">
                    <button class="settings-tab active" data-tab="agents">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        Agents
                    </button>
                    <button class="settings-tab" data-tab="tools">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                        Tools
                    </button>
                    <button class="settings-tab" data-tab="security">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        Security
                    </button>
                    <button class="settings-tab" data-tab="help">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Help
                    </button>
                </nav>
                <div class="settings-content" id="settings-content">
                    <div class="flex items-center justify-center py-12">
                        <div class="flex items-center gap-2 text-warm-400">
                            <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span class="text-sm">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-footer">
                <div class="flex items-center gap-2 text-sm text-warm-600">
                    <div class="w-2 h-2 rounded-full bg-forest pulse-soft"></div>
                    <span class="font-medium">{{.User.DisplayName}}</span>
                </div>
                <form method="POST" action="/logout" class="inline">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit" class="text-sm text-warm-500 hover:text-danger font-medium">
                        Sign Out
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Chat App Layout */
.chat-app {
    display: grid;
    grid-template-columns: 256px 1fr;
    grid-template-rows: auto 1fr;
    height: 100vh;
    overflow: hidden;
}

.chat-header {
    grid-column: 1 / -1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1.5rem;
    background: white;
    border-bottom: 1px solid #E8E2DA;
    z-index: 20;
}

.chat-sidebar {
    display: flex;
    flex-direction: column;
    background: white;
    border-right: 1px solid #E8E2DA;
    overflow: hidden;
    z-index: 10;
}

.chat-content {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #FAF8F5;
}

/* Sidebar Content */
.sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 1rem;
}

.new-chat-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.75rem 1rem;
    background: #2D5A47;
    color: white;
    font-weight: 500;
    font-size: 0.875rem;
    border-radius: 0.5rem;
    transition: background 0.15s ease;
    margin-bottom: 1rem;
}

.new-chat-btn:hover {
    background: #3D7A5F;
}

.thread-list {
    flex: 1;
    overflow-y: auto;
}

/* Thread Groups */
.thread-group {
    margin-bottom: 1rem;
}

.thread-group-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #9A8A78;
    padding: 0.5rem 0.75rem;
}

/* Thread Item */
.thread-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background 0.1s ease;
}

.thread-item:hover {
    background: #F5F1EC;
}

.thread-item.active {
    background: rgba(45, 90, 71, 0.08);
}

.thread-item.active .thread-title {
    color: #2D5A47;
    font-weight: 500;
}

.thread-icon {
    flex-shrink: 0;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #F5F1EC;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: #5A4A38;
}

.thread-info {
    flex: 1;
    min-width: 0;
}

.thread-title {
    font-size: 0.875rem;
    color: #1C1917;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.thread-meta {
    font-size: 0.7rem;
    color: #9A8A78;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-top: 0.125rem;
}

.thread-agent-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.375rem;
    background: rgba(45, 90, 71, 0.1);
    color: #2D5A47;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    font-weight: 500;
}

.thread-agent-badge.offline {
    background: rgba(154, 138, 120, 0.1);
    color: #9A8A78;
}

/* Disconnected threads - collapsible section */
.disconnected-group {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #E8E2DA;
}

.disconnected-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;
    border-radius: 0.375rem;
    transition: background 0.1s ease;
}

.disconnected-toggle:hover {
    background: #F5F1EC;
}

.disconnected-toggle .thread-group-label {
    padding: 0;
    flex: 1;
}

.disconnected-count {
    font-size: 0.625rem;
    font-weight: 600;
    background: #E8E2DA;
    color: #7A6A58;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
}

.toggle-chevron {
    color: #9A8A78;
    transition: transform 0.2s ease;
}

.disconnected-group.expanded .toggle-chevron {
    transform: rotate(90deg);
}

.disconnected-threads {
    display: none;
    padding-top: 0.25rem;
}

.disconnected-group.expanded .disconnected-threads {
    display: block;
}

/* Disconnected thread item styling */
.thread-item.disconnected {
    opacity: 0.7;
}

.thread-item.disconnected .thread-title {
    color: #7A6A58;
}

.thread-item.disconnected .thread-icon {
    background: #F5F1EC;
}

/* Sidebar Footer */
.sidebar-footer {
    display: flex;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    border-top: 1px solid #E8E2DA;
    background: #FAF8F5;
}

.sidebar-nav-link {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem;
    font-size: 0.65rem;
    color: #7A6A58;
    border-radius: 0.375rem;
    transition: all 0.1s ease;
}

.sidebar-nav-link:hover {
    color: #2D5A47;
    background: rgba(45, 90, 71, 0.08);
}

/* Sidebar overlay - hidden on desktop, shown on mobile */
.sidebar-overlay {
    display: none;
}

/* Mobile Sidebar */
@media (max-width: 1023px) {
    .chat-app {
        grid-template-columns: 1fr;
    }

    .chat-sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 256px;
        transform: translateX(-100%);
        transition: transform 0.2s ease;
        z-index: 40;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
    }

    .chat-sidebar.open {
        transform: translateX(0);
    }

    .sidebar-overlay {
        display: block;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease;
        z-index: 35;
    }

    .sidebar-overlay.open {
        opacity: 1;
        visibility: visible;
    }
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
    z-index: 50;
    opacity: 1;
    transition: opacity 0.15s ease;
}

.modal-overlay.hidden {
    opacity: 0;
    pointer-events: none;
}

.modal-container {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    width: 90%;
    max-width: 400px;
    max-height: 60vh;
    display: flex;
    flex-direction: column;
    animation: modal-in 0.15s ease;
}

@keyframes modal-in {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #E8E2DA;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

/* Agent Picker Items */
.agent-picker-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background 0.1s ease;
}

.agent-picker-item:hover {
    background: #F5F1EC;
}

.agent-status-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    flex-shrink: 0;
}

.agent-status-dot.online {
    background: #2D5A47;
}

.agent-status-dot.offline {
    background: #D4C9BC;
}

/* Search Modal */
.search-container {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    width: 90%;
    max-width: 600px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
    animation: modal-in 0.15s ease;
}

.search-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #E8E2DA;
}

.search-input {
    flex: 1;
    font-size: 1rem;
    color: #1C1917;
    background: transparent;
    border: none;
    outline: none;
}

.search-input::placeholder {
    color: #B8A896;
}

.search-kbd {
    padding: 0.125rem 0.5rem;
    background: #F5F1EC;
    border: 1px solid #E8E2DA;
    border-radius: 0.25rem;
    font-size: 0.65rem;
    color: #7A6A58;
    font-family: inherit;
}

.search-results {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

/* Keyboard hint */
.keyboard-hints {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    padding: 0.75rem;
    font-size: 0.7rem;
    color: #9A8A78;
    border-top: 1px solid #E8E2DA;
}

.keyboard-hint {
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.keyboard-hint kbd {
    padding: 0.125rem 0.375rem;
    background: #F5F1EC;
    border: 1px solid #E8E2DA;
    border-radius: 0.25rem;
    font-size: 0.625rem;
    font-family: inherit;
}

/* Settings Modal */
.settings-container {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    width: 90%;
    max-width: 900px;
    height: 80vh;
    max-height: 700px;
    display: flex;
    flex-direction: column;
    animation: modal-in 0.15s ease;
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #E8E2DA;
    flex-shrink: 0;
}

.settings-body {
    flex: 1;
    display: flex;
    overflow: hidden;
}

.settings-nav {
    width: 180px;
    padding: 1rem;
    border-right: 1px solid #E8E2DA;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex-shrink: 0;
}

.settings-tab {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6B5C4D;
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;
    transition: all 0.1s ease;
}

.settings-tab:hover {
    background: #F5F1EC;
    color: #2D5A47;
}

.settings-tab.active {
    background: #2D5A47;
    color: white;
}

.settings-tab.active svg {
    opacity: 1;
}

.settings-tab svg {
    opacity: 0.7;
    flex-shrink: 0;
}

.settings-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.settings-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-top: 1px solid #E8E2DA;
    background: #FDFCFB;
    border-radius: 0 0 0.75rem 0.75rem;
    flex-shrink: 0;
}

/* Settings Content Sections */
.settings-section {
    margin-bottom: 2rem;
}

.settings-section:last-child {
    margin-bottom: 0;
}

.settings-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #9A8A78;
    margin-bottom: 1rem;
}

.settings-table {
    width: 100%;
    border-collapse: collapse;
}

.settings-table th {
    text-align: left;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #9A8A78;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #E8E2DA;
}

.settings-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #F5F1EC;
    font-size: 0.875rem;
    color: #3D3228;
}

.settings-table tr:hover td {
    background: #FDFCFB;
}

/* Agent list in settings */
.settings-agent-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border: 1px solid #E8E2DA;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    transition: all 0.1s ease;
}

.settings-agent-item:hover {
    border-color: #D4C9BC;
    background: #FDFCFB;
}

.settings-agent-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.settings-agent-name {
    font-weight: 500;
    color: #3D3228;
}

.settings-agent-meta {
    font-size: 0.75rem;
    color: #9A8A78;
}

/* Responsive settings modal */
@media (max-width: 768px) {
    .settings-container {
        width: 100%;
        height: 100%;
        max-height: none;
        border-radius: 0;
    }

    .settings-body {
        flex-direction: column;
    }

    .settings-nav {
        width: 100%;
        flex-direction: row;
        border-right: none;
        border-bottom: 1px solid #E8E2DA;
        padding: 0.5rem;
        overflow-x: auto;
    }

    .settings-tab {
        white-space: nowrap;
        padding: 0.5rem 0.75rem;
    }
}
</style>

<script>
(function() {
    // Detect client platform and update modifier key display
    const isMac = navigator.platform?.toUpperCase().indexOf('MAC') >= 0 ||
                  navigator.userAgentData?.platform?.toUpperCase().indexOf('MAC') >= 0;
    document.querySelectorAll('.mod-key').forEach(el => {
        el.textContent = isMac ? 'âŒ˜' : 'Ctrl';
    });

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const newChatBtn = document.getElementById('new-chat-btn');
    const agentPickerModal = document.getElementById('agent-picker-modal');
    const closeAgentPicker = document.getElementById('close-agent-picker');
    const searchModal = document.getElementById('search-modal');
    const searchInput = document.getElementById('search-input');
    const settingsModal = document.getElementById('settings-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettings = document.getElementById('close-settings');
    const settingsContent = document.getElementById('settings-content');

    // Handle ?agent= query parameter (from admin "Chat" buttons)
    function handleAgentQueryParam() {
        const params = new URLSearchParams(window.location.search);
        const agentId = params.get('agent');
        if (!agentId) return;

        // Clear the URL param to avoid re-triggering on refresh
        const url = new URL(window.location);
        url.searchParams.delete('agent');
        window.history.replaceState({}, '', url);

        // Extract CSRF token for the POST request
        const csrfToken = document.querySelector('[hx-headers]')?.getAttribute('hx-headers')?.match(/"X-CSRF-Token":\s*"([^"]+)"/)?.[1];

        // Create new thread with this agent
        htmx.ajax('POST', '/threads', {
            values: { agent_id: agentId },
            target: '#chat-content',
            swap: 'innerHTML',
            headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {}
        }).then(() => {
            // Refresh thread list
            htmx.trigger('#thread-list', 'load');
        });
    }

    // Run after page loads and HTMX is ready
    document.addEventListener('htmx:load', function onFirstLoad() {
        document.removeEventListener('htmx:load', onFirstLoad);
        handleAgentQueryParam();
    });

    // Mobile sidebar toggle
    function toggleSidebar() {
        sidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('open');
    }

    sidebarToggle?.addEventListener('click', toggleSidebar);
    sidebarOverlay?.addEventListener('click', toggleSidebar);

    // Agent picker modal
    function openAgentPicker() {
        agentPickerModal?.classList.remove('hidden');
        // Refresh agent list
        htmx.trigger('#agent-list', 'load');
    }

    function closeAgentPickerModal() {
        agentPickerModal?.classList.add('hidden');
    }

    newChatBtn?.addEventListener('click', openAgentPicker);
    closeAgentPicker?.addEventListener('click', closeAgentPickerModal);

    // Search modal
    function openSearch() {
        searchModal?.classList.remove('hidden');
        setTimeout(() => searchInput?.focus(), 50);
    }

    function closeSearch() {
        searchModal?.classList.add('hidden');
        if (searchInput) searchInput.value = '';
    }

    // Click outside modal to close
    agentPickerModal?.addEventListener('click', (e) => {
        if (e.target === agentPickerModal) closeAgentPickerModal();
    });

    searchModal?.addEventListener('click', (e) => {
        if (e.target === searchModal) closeSearch();
    });

    // Settings modal
    let currentSettingsTab = 'agents';

    function openSettings(tab = 'agents') {
        currentSettingsTab = tab;
        settingsModal?.classList.remove('hidden');
        // Update active tab
        document.querySelectorAll('.settings-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === tab);
        });
        // Load tab content
        loadSettingsTab(tab);
    }

    function closeSettingsModal() {
        settingsModal?.classList.add('hidden');
    }

    function loadSettingsTab(tab) {
        if (settingsContent) {
            settingsContent.innerHTML = '<div class="flex items-center justify-center py-12"><div class="flex items-center gap-2 text-warm-400"><svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg><span class="text-sm">Loading...</span></div></div>';
            htmx.ajax('GET', '/settings/' + tab, {
                target: '#settings-content',
                swap: 'innerHTML'
            });
        }
    }

    settingsBtn?.addEventListener('click', () => openSettings());
    closeSettings?.addEventListener('click', closeSettingsModal);

    settingsModal?.addEventListener('click', (e) => {
        if (e.target === settingsModal) closeSettingsModal();
    });

    // Settings tab switching
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            if (tabName && tabName !== currentSettingsTab) {
                openSettings(tabName);
            }
        });
    });

    // Sidebar footer buttons that open settings to specific tab
    document.querySelectorAll('[data-settings-tab]').forEach(btn => {
        if (!btn.classList.contains('settings-tab')) {
            btn.addEventListener('click', () => {
                openSettings(btn.dataset.settingsTab);
            });
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Cmd/Ctrl + K = Search
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            if (searchModal?.classList.contains('hidden')) {
                openSearch();
            } else {
                closeSearch();
            }
        }

        // Cmd/Ctrl + N = New Chat
        if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
            e.preventDefault();
            openAgentPicker();
        }

        // Cmd/Ctrl + Shift + S = Toggle Sidebar (desktop only)
        if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 's') {
            e.preventDefault();
            toggleSidebar();
        }

        // Escape = Close modals
        if (e.key === 'Escape') {
            if (!settingsModal?.classList.contains('hidden')) {
                closeSettingsModal();
            }
            if (!agentPickerModal?.classList.contains('hidden')) {
                closeAgentPickerModal();
            }
            if (!searchModal?.classList.contains('hidden')) {
                closeSearch();
            }
            // Close sidebar on mobile
            if (sidebar?.classList.contains('open')) {
                toggleSidebar();
            }
        }
    });

    // Search input handler with debounce
    let searchTimeout;
    searchInput?.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
            document.getElementById('search-results').innerHTML =
                '<p class="text-sm text-warm-400 text-center py-8">Type to search threads...</p>';
            return;
        }

        searchTimeout = setTimeout(() => {
            htmx.ajax('GET', '/threads/search?q=' + encodeURIComponent(query), {
                target: '#search-results',
                swap: 'innerHTML'
            });
        }, 200);
    });

    // Handle agent selection from picker
    document.addEventListener('click', function(e) {
        const agentItem = e.target.closest('.agent-picker-item');
        if (agentItem && agentItem.dataset.agentId) {
            const agentId = agentItem.dataset.agentId;
            closeAgentPickerModal();

            // Extract CSRF token for the POST request
            const csrfToken = document.querySelector('[hx-headers]')?.getAttribute('hx-headers')?.match(/"X-CSRF-Token":\s*"([^"]+)"/)?.[1];

            // Create new thread with this agent
            htmx.ajax('POST', '/threads', {
                values: { agent_id: agentId },
                target: '#chat-content',
                swap: 'innerHTML',
                headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {}
            }).then(() => {
                // Refresh thread list
                htmx.trigger('#thread-list', 'load');
            });
        }
    });

    // Handle thread selection
    document.addEventListener('click', function(e) {
        const threadItem = e.target.closest('.thread-item');
        if (threadItem && threadItem.dataset.threadId) {
            const threadId = threadItem.dataset.threadId;

            // Remove active class from all threads
            document.querySelectorAll('.thread-item').forEach(t => t.classList.remove('active'));
            // Add active class to clicked thread
            threadItem.classList.add('active');

            // Load thread content
            htmx.ajax('GET', '/chatview/' + threadId, {
                target: '#chat-content',
                swap: 'innerHTML'
            });

            // Close sidebar on mobile
            if (window.innerWidth < 1024 && sidebar?.classList.contains('open')) {
                toggleSidebar();
            }
        }
    });

    // Thread right-click context menu (delete/rename)
    document.addEventListener('contextmenu', function(e) {
        const threadItem = e.target.closest('.thread-item');
        if (threadItem) {
            e.preventDefault();
            showThreadContextMenu(e, threadItem);
        }
    });

    function showThreadContextMenu(e, threadItem) {
        // Remove any existing context menu
        document.querySelector('.context-menu')?.remove();

        const threadId = threadItem.dataset.threadId;
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.innerHTML = `
            <button class="context-menu-item" data-action="rename">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Rename
            </button>
            <button class="context-menu-item text-danger" data-action="delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete
            </button>
        `;
        menu.style.cssText = `
            position: fixed;
            left: ${e.clientX}px;
            top: ${e.clientY}px;
            background: white;
            border: 1px solid #E8E2DA;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.25rem;
            z-index: 100;
        `;

        document.body.appendChild(menu);

        // Handle menu item clicks
        const csrfToken = document.querySelector('[hx-headers]')?.getAttribute('hx-headers')?.match(/"X-CSRF-Token":\s*"([^"]+)"/)?.[1];
        menu.addEventListener('click', function(e) {
            const action = e.target.closest('.context-menu-item')?.dataset.action;
            if (action === 'delete') {
                if (confirm('Delete this conversation?')) {
                    htmx.ajax('DELETE', '/threads/' + threadId, {
                        headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {}
                    }).then(() => {
                        htmx.trigger('#thread-list', 'load');
                        // If this was the active thread, show empty state
                        if (threadItem.classList.contains('active')) {
                            htmx.ajax('GET', '/chatview/empty', {
                                target: '#chat-content',
                                swap: 'innerHTML'
                            });
                        }
                    });
                }
            } else if (action === 'rename') {
                const newName = prompt('Enter new name:');
                if (newName) {
                    htmx.ajax('PATCH', '/threads/' + threadId, {
                        values: { title: newName },
                        headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {}
                    }).then(() => {
                        htmx.trigger('#thread-list', 'load');
                    });
                }
            }
            menu.remove();
        });

        // Close on click outside
        setTimeout(() => {
            document.addEventListener('click', function closeMenu() {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }, { once: true });
        }, 0);
    }
})();
</script>

<!-- Context menu styles -->
<style>
.context-menu-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: #5A4A38;
    border-radius: 0.375rem;
    transition: background 0.1s ease;
    text-align: left;
}

.context-menu-item:hover {
    background: #F5F1EC;
}

.context-menu-item.text-danger {
    color: #A94442;
}

.context-menu-item.text-danger:hover {
    background: rgba(169, 68, 66, 0.08);
}
</style>
{{end}}

{{/* Empty state template for when no thread is selected */}}
{{define "empty_state"}}
{{if gt .AgentCount 0}}
{{/* Agents are connected - show normal welcome */}}
<div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
    <div class="w-20 h-20 rounded-2xl bg-forest/10 flex items-center justify-center mb-6">
        <svg class="w-10 h-10 text-forest" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
    </div>
    <h2 class="font-serif text-2xl text-ink mb-2">Welcome to Coven</h2>
    <p class="text-warm-500 text-sm max-w-sm mb-6">Select a conversation from the sidebar or start a new chat with an agent.</p>
    <button id="welcome-new-chat" class="inline-flex items-center gap-2 px-5 py-2.5 bg-forest text-white font-medium text-sm rounded-lg hover:bg-forest-light transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/>
        </svg>
        Start New Chat
    </button>
    <div class="mt-8 flex gap-6 text-xs text-warm-400">
        <div class="keyboard-hint">
            <kbd><span class="mod-key">Ctrl</span>+N</kbd>
            <span>New Chat</span>
        </div>
        <div class="keyboard-hint">
            <kbd><span class="mod-key">Ctrl</span>+K</kbd>
            <span>Search</span>
        </div>
    </div>
</div>
<script>
document.getElementById('welcome-new-chat')?.addEventListener('click', function() {
    document.getElementById('new-chat-btn')?.click();
});
</script>
{{else}}
{{/* No agents connected - show launch agent prompt */}}
<div id="no-agents-state" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
    <div class="w-20 h-20 rounded-2xl bg-warm-100 flex items-center justify-center mb-6">
        <svg class="w-10 h-10 text-warm-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
    </div>
    <h2 class="font-serif text-2xl text-ink mb-2">No Agents Connected</h2>
    <p class="text-warm-500 text-sm max-w-sm mb-6">Launch an agent to start chatting. The page will automatically refresh when an agent connects.</p>
    <div class="bg-warm-50 border border-warm-200 rounded-lg p-4 max-w-md text-left mb-6">
        <p class="text-xs font-medium text-warm-600 mb-2">Launch an agent with:</p>
        <code class="block bg-white border border-warm-200 rounded px-3 py-2 text-sm font-mono text-ink">coven agent</code>
    </div>
    <div class="flex items-center gap-2 text-sm text-warm-400">
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span>Waiting for agents...</span>
    </div>
</div>
<script>
(function() {
    // Poll for agent connections every 3 seconds
    let pollInterval = setInterval(async function() {
        try {
            const response = await fetch('/agents/count');
            if (response.ok) {
                const count = parseInt(await response.text(), 10);
                if (count > 0) {
                    clearInterval(pollInterval);
                    // Full page reload to update sidebar and content
                    window.location.reload();
                }
            }
        } catch (e) {
            // Ignore errors, will retry
        }
    }, 3000);

    // Clean up on navigation
    document.body.addEventListener('htmx:beforeSwap', function cleanup() {
        clearInterval(pollInterval);
        document.body.removeEventListener('htmx:beforeSwap', cleanup);
    }, { once: true });
})();
</script>
{{end}}
{{end}}

{{/* Chat view template for active conversation */}}
{{define "chat_view"}}
<div class="flex-1 flex flex-col overflow-hidden">
    <!-- Chat Header -->
    <div class="chat-view-header">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-forest/10 flex items-center justify-center">
                <svg class="w-4 h-4 text-forest" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
            </div>
            <div>
                <h2 class="font-medium text-ink text-sm">{{.AgentName}}</h2>
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 rounded-full {{if .Connected}}bg-forest{{else}}bg-warm-300{{end}}"></div>
                    <span class="text-xs text-warm-500">{{if .Connected}}Online{{else}}Offline{{end}}</span>
                </div>
            </div>
        </div>
        <a href="/admin/agents/{{.AgentID}}" class="text-xs text-warm-500 hover:text-forest">Agent Details</a>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="chat-messages">
        {{if .Messages}}
        {{range .Messages}}
        {{if eq .Type "tool_use"}}
        <div class="message message-agent message-tool-block">
            <div class="tool-block-wrapper">
                <div class="tool-block-header collapsed" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                    <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                    <svg class="tool-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <span class="tool-label">{{.ToolName}}</span>
                </div>
                <div class="tool-block-body collapsed">{{.Content}}</div>
            </div>
        </div>
        {{else if eq .Type "tool_result"}}
        <div class="message message-agent message-tool-block">
            <div class="result-block-wrapper">
                <div class="result-block-header collapsed" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                    <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                    <svg class="result-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="result-label">Result</span>
                </div>
                <div class="result-block-body collapsed">{{.Content}}</div>
            </div>
        </div>
        {{else}}
        <div class="message {{if eq .Sender "user"}}message-user{{else}}message-agent{{end}}">
            <div class="message-header">
                {{if eq .Sender "user"}}
                <span class="message-sender user">You</span>
                {{else}}
                <span class="message-sender agent">{{$.AgentName}}</span>
                {{end}}
                <span class="message-time">{{.CreatedAt.Format "15:04"}}</span>
            </div>
            <div class="message-content">{{.Content}}</div>
        </div>
        {{end}}
        {{end}}
        {{else}}
        <div class="flex flex-col items-center justify-center h-full text-warm-400">
            <p class="text-sm">Start the conversation</p>
        </div>
        {{end}}
    </div>

    <!-- Input Area -->
    <div class="chat-input-area">
        {{if .Connected}}
        <form id="chat-form" class="chat-form">
            <input type="hidden" name="thread_id" value="{{.ThreadID}}">
            <textarea id="message-input" name="message" placeholder="Type a message..." class="chat-textarea" rows="1"></textarea>
            <button type="submit" class="chat-send-btn">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
            </button>
        </form>
        {{else}}
        <div class="flex items-center justify-center gap-2 text-warm-500 py-4">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414"/>
            </svg>
            <span class="text-sm font-medium">Agent offline. Cannot send messages.</span>
        </div>
        {{end}}
    </div>
</div>

<style>
.chat-view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1.5rem;
    background: white;
    border-bottom: 1px solid #E8E2DA;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem 1.5rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.message {
    max-width: 85%;
    animation: message-appear 0.2s ease-out;
}

@keyframes message-appear {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-user {
    align-self: flex-end;
}

.message-agent {
    align-self: flex-start;
}

/* Tool/result messages span full width */
.message-tool-block {
    max-width: 100%;
    align-self: stretch;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.message-sender {
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
}

.message-sender.user {
    background: rgba(74, 106, 140, 0.1);
    color: #4A6A8C;
}

.message-sender.agent {
    background: #F5F1EC;
    color: #5A4A38;
}

.message-sender.tool {
    background: rgba(184, 134, 11, 0.15);
    color: #96750A;
}

.message-sender.result {
    background: rgba(45, 90, 71, 0.15);
    color: #2D5A47;
}

.message-sender.thinking {
    background: rgba(128, 90, 213, 0.1);
    color: #6B46C1;
}

.message-sender.error {
    background: rgba(169, 68, 66, 0.1);
    color: #A94442;
}

.message-time {
    font-size: 0.65rem;
    color: #B8A896;
}

.message-content {
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid #E8E2DA;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}

.message-user .message-content {
    background: #2D5A47;
    color: white;
    border-color: #2D5A47;
    border-radius: 0.75rem 0.75rem 0.25rem 0.75rem;
}

.message-agent .message-content {
    border-radius: 0.75rem 0.75rem 0.75rem 0.25rem;
}

/* Tool blocks - darker terminal style */
.message-content.tool {
    background: #1a1d21;
    border-color: #2d3138;
    border-radius: 0.5rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: #c4cad6;
    overflow-x: auto;
    max-height: 300px;
    overflow-y: auto;
}

/* Result blocks - success themed */
.message-content.result {
    background: rgba(45, 90, 71, 0.04);
    border-color: rgba(45, 90, 71, 0.25);
    border-left: 3px solid #2D5A47;
    border-radius: 0 0.5rem 0.5rem 0;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: #3D3228;
    overflow-x: auto;
    max-height: 300px;
    overflow-y: auto;
}

/* Thinking blocks */
.message-content.thinking {
    background: rgba(128, 90, 213, 0.04);
    border-color: rgba(128, 90, 213, 0.2);
    border-left: 3px solid #805AD5;
    border-radius: 0 0.5rem 0.5rem 0;
    font-style: italic;
    color: #6B46C1;
}

/* Error blocks */
.message-content.error {
    background: rgba(169, 68, 66, 0.04);
    border-color: rgba(169, 68, 66, 0.2);
    border-left: 3px solid #A94442;
    border-radius: 0 0.5rem 0.5rem 0;
    color: #A94442;
}

/* Collapsible tool blocks */
.tool-block-wrapper {
    border: 1px solid #2d3138;
    border-radius: 0.5rem;
    overflow: hidden;
    background: #1a1d21;
}

.tool-block-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #22262c;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s ease;
}

.tool-block-header:hover {
    background: #2a2f36;
}

.tool-block-header .chevron {
    width: 16px;
    height: 16px;
    color: #6b7280;
    transition: transform 0.2s ease;
}

.tool-block-header.collapsed .chevron {
    transform: rotate(-90deg);
}

.tool-block-header .tool-icon {
    width: 16px;
    height: 16px;
    color: #D4A017;
}

.tool-block-header .tool-label {
    flex: 1;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    font-weight: 500;
    color: #D4A017;
}

.tool-block-body {
    padding: 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: #c4cad6;
    white-space: pre-wrap;
    word-break: break-word;
    overflow-x: auto;
    max-height: 300px;
    overflow-y: auto;
}

.tool-block-body.collapsed {
    display: none;
}

/* Result block wrapper */
.result-block-wrapper {
    border: 1px solid rgba(45, 90, 71, 0.25);
    border-left: 3px solid #2D5A47;
    border-radius: 0 0.5rem 0.5rem 0;
    overflow: hidden;
    background: rgba(45, 90, 71, 0.04);
}

.result-block-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: rgba(45, 90, 71, 0.08);
    cursor: pointer;
    user-select: none;
    transition: background 0.15s ease;
}

.result-block-header:hover {
    background: rgba(45, 90, 71, 0.12);
}

.result-block-header .chevron {
    width: 16px;
    height: 16px;
    color: #2D5A47;
    transition: transform 0.2s ease;
}

.result-block-header.collapsed .chevron {
    transform: rotate(-90deg);
}

.result-block-header .result-icon {
    width: 16px;
    height: 16px;
    color: #2D5A47;
}

.result-block-header .result-label {
    flex: 1;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    font-weight: 500;
    color: #2D5A47;
}

.result-block-body {
    padding: 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: #3D3228;
    white-space: pre-wrap;
    word-break: break-word;
    overflow-x: auto;
    max-height: 300px;
    overflow-y: auto;
}

.result-block-body.collapsed {
    display: none;
}

.chat-input-area {
    padding: 1rem 1.5rem;
    background: white;
    border-top: 1px solid #E8E2DA;
}

.chat-form {
    display: flex;
    align-items: flex-end;
    gap: 0.75rem;
}

.chat-textarea {
    flex: 1;
    padding: 0.75rem 1rem;
    background: #F5F1EC;
    border: 1px solid #E8E2DA;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    resize: none;
    min-height: 44px;
    max-height: 200px;
    font-family: inherit;
    transition: all 0.15s ease;
}

.chat-textarea:focus {
    outline: none;
    border-color: #2D5A47;
    background: white;
    box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.08);
}

.chat-send-btn {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #2D5A47;
    color: white;
    border-radius: 0.75rem;
    transition: all 0.15s ease;
}

.chat-send-btn:hover {
    background: #3D7A5F;
    transform: translateY(-1px);
}

.chat-send-btn:active {
    transform: translateY(0);
}

.chat-send-btn:disabled {
    background: #D4C9BC;
    cursor: not-allowed;
    transform: none;
}
</style>

<script>
(function() {
    const agentId = {{.AgentID | js}};
    const threadId = {{.ThreadID | js}};
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');

    // Auto-resize textarea
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Submit on Enter (Shift+Enter for newline)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm?.requestSubmit();
            }
        });
    }

    // Scroll to bottom
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Streaming state
    let currentStreamingMessage = null;
    let streamingContent = '';
    let isStreaming = false;
    let currentThinkingBlock = null;

    // SSE connection
    let evtSource = null;
    let reconnectAttempts = 0;

    // Clean up SSE on page unload or HTMX swap
    function cleanupSSE() {
        if (evtSource) {
            evtSource.close();
            evtSource = null;
        }
    }
    window.addEventListener('beforeunload', cleanupSSE);
    document.body.addEventListener('htmx:beforeSwap', cleanupSSE);

    function connectSSE() {
        evtSource = new EventSource('/chat/' + agentId + '/stream');

        evtSource.addEventListener('connected', function() {
            console.log('SSE connected');
            reconnectAttempts = 0;
        });

        evtSource.addEventListener('text', function(e) {
            try {
                const data = JSON.parse(e.data);
                appendStreamText(data.content || '');
            } catch {
                appendStreamText(e.data);
            }
        });

        evtSource.addEventListener('thinking', function(e) {
            console.log('[chat] thinking event:', e.data);
            try {
                const data = JSON.parse(e.data);
                if (data.content) appendThinkingBlock(data.content);
            } catch {}
        });

        evtSource.addEventListener('tool_use', function(e) {
            console.log('[chat] tool_use event:', e.data);
            try {
                const data = JSON.parse(e.data);
                appendToolBlock('use', data.tool_name, data.content);
            } catch {}
        });

        evtSource.addEventListener('tool_result', function(e) {
            try {
                const data = JSON.parse(e.data);
                if (data.content) appendToolBlock('result', null, data.content);
            } catch {}
        });

        evtSource.addEventListener('done', function() {
            finalizeStreaming();
        });

        evtSource.addEventListener('error', function(e) {
            if (e.data) {
                try {
                    const data = JSON.parse(e.data);
                    appendError(data.content || 'An error occurred');
                } catch {
                    appendError(e.data);
                }
                finalizeStreaming();
            } else if (evtSource.readyState === EventSource.CLOSED) {
                attemptReconnect();
            }
        });
    }

    function attemptReconnect() {
        if (reconnectAttempts >= 5) return;
        reconnectAttempts++;
        setTimeout(connectSSE, 2000 * reconnectAttempts);
    }

    function startStreaming() {
        if (isStreaming) return;
        isStreaming = true;
        streamingContent = '';

        currentStreamingMessage = document.createElement('div');
        currentStreamingMessage.className = 'message message-agent streaming';
        currentStreamingMessage.innerHTML = `
            <div class="message-header">
                <span class="message-sender agent">{{.AgentName}}</span>
                <span class="throbber"></span>
            </div>
            <div class="message-content"></div>
        `;
        chatMessages.appendChild(currentStreamingMessage);

        scrollToBottom();
    }

    function appendStreamText(text) {
        // Remove thinking block when actual text starts coming in
        removeThinkingBlock();

        if (!currentStreamingMessage) startStreaming();
        streamingContent += text;
        const contentDiv = currentStreamingMessage.querySelector('.message-content');
        if (contentDiv) contentDiv.textContent = streamingContent;
        scrollToBottom();
    }

    function finalizeStreaming() {
        // Remove any lingering thinking block
        removeThinkingBlock();

        if (!currentStreamingMessage) return;
        isStreaming = false;

        currentStreamingMessage.querySelector('.throbber')?.remove();
        currentStreamingMessage.classList.remove('streaming');

        const contentDiv = currentStreamingMessage.querySelector('.message-content');
        if (contentDiv && streamingContent && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
            contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(streamingContent));
            // Switch from whitespace-pre-wrap to prose styling after markdown rendering
            contentDiv.classList.remove('whitespace-pre-wrap');
            contentDiv.classList.add('prose', 'prose-sm', 'max-w-none');
        }

        currentStreamingMessage = null;
        streamingContent = '';
        scrollToBottom();
    }

    function appendThinkingBlock(content) {
        console.log('[chat] appendThinkingBlock, currentThinkingBlock:', currentThinkingBlock);
        // Clear any pending messages first (streaming or previous thinking)
        clearPendingMessages();

        const msg = document.createElement('div');
        msg.className = 'message message-agent thinking-block';
        msg.innerHTML = `
            <div class="message-header">
                <span class="message-sender thinking">Thinking...</span>
            </div>
            <div class="message-content thinking">${escapeHtml(content)}</div>
        `;
        chatMessages.appendChild(msg);
        currentThinkingBlock = msg;
        scrollToBottom();
    }

    function removeThinkingBlock() {
        if (currentThinkingBlock) {
            console.log('[chat] removing thinking block');
            currentThinkingBlock.remove();
            currentThinkingBlock = null;
        }
    }

    function clearPendingMessages() {
        // Remove thinking block
        removeThinkingBlock();

        // Handle any current streaming message
        if (currentStreamingMessage) {
            if (streamingContent) {
                finalizeStreaming();
            } else {
                // Remove empty streaming message
                currentStreamingMessage.remove();
                currentStreamingMessage = null;
                isStreaming = false;
            }
        }
    }

    function appendToolBlock(type, toolName, content) {
        console.log('[chat] appendToolBlock:', type, toolName, 'currentThinkingBlock:', currentThinkingBlock);
        // Clear any pending messages first
        clearPendingMessages();

        const msg = document.createElement('div');
        msg.className = 'message message-agent message-tool-block';

        if (type === 'use') {
            // Collapsible tool use block (collapsed by default)
            const blockId = 'tool-' + Date.now();
            msg.innerHTML = `
                <div class="tool-block-wrapper">
                    <div class="tool-block-header collapsed" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                        <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <svg class="tool-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <span class="tool-label">${escapeHtml(toolName || 'Tool')}</span>
                    </div>
                    ${content ? `<div class="tool-block-body collapsed">${escapeHtml(content)}</div>` : ''}
                </div>
            `;
        } else {
            // Collapsible result block (collapsed by default)
            msg.innerHTML = `
                <div class="result-block-wrapper">
                    <div class="result-block-header collapsed" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                        <svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                        <svg class="result-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="result-label">Result</span>
                    </div>
                    ${content ? `<div class="result-block-body collapsed">${escapeHtml(content)}</div>` : ''}
                </div>
            `;
        }

        chatMessages.appendChild(msg);
        scrollToBottom();
    }

    function appendError(content) {
        // Clear any pending messages first
        clearPendingMessages();

        const msg = document.createElement('div');
        msg.className = 'message message-agent';
        msg.innerHTML = `
            <div class="message-header">
                <span class="message-sender error">Error</span>
            </div>
            <div class="message-content error">${escapeHtml(content)}</div>
        `;
        chatMessages.appendChild(msg);
        scrollToBottom();
    }

    function appendUserMessage(content) {
        const msg = document.createElement('div');
        msg.className = 'message message-user';
        msg.innerHTML = `
            <div class="message-header">
                <span class="message-sender user">You</span>
                <span class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
            </div>
            <div class="message-content">${escapeHtml(content)}</div>
        `;
        chatMessages.appendChild(msg);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Form submission
    chatForm?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        appendUserMessage(message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        startStreaming();

        try {
            const formData = new FormData();
            formData.append('message', message);
            formData.append('thread_id', threadId);

            const csrfToken = document.querySelector('[hx-headers]')?.getAttribute('hx-headers')?.match(/"X-CSRF-Token":\s*"([^"]+)"/)?.[1];

            const response = await fetch('/chat/' + agentId + '/send', {
                method: 'POST',
                body: formData,
                headers: csrfToken ? { 'X-CSRF-Token': csrfToken } : {}
            });

            if (!response.ok) throw new Error('Server error: ' + response.status);
        } catch (err) {
            finalizeStreaming();
            appendError('Failed to send: ' + err.message);
        }
    });

    // Start SSE if connected
    {{if .Connected}}
    connectSSE();
    {{end}}
})();
</script>

<style>
/* Streaming state */
.streaming .message-content {
    border-left: 3px solid #2D5A47;
    background: linear-gradient(90deg, rgba(45, 90, 71, 0.04) 0%, transparent 100%) !important;
    position: relative;
}

.streaming .message-content::after {
    content: '';
    display: inline-block;
    width: 2px;
    height: 1.1em;
    background: #2D5A47;
    margin-left: 2px;
    vertical-align: text-bottom;
    animation: cursor-blink 0.8s step-end infinite;
}

@keyframes cursor-blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

.throbber {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    margin-left: 0.5rem;
}

.throbber::before {
    content: '';
    width: 6px;
    height: 6px;
    background: #2D5A47;
    border-radius: 50%;
    animation: throbber-pulse 1s ease-in-out infinite;
}

@keyframes throbber-pulse {
    0%, 100% { opacity: 0.4; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1); }
}

/* Markdown styles */
.message-content pre {
    background: #1a1d21;
    color: #e5e7eb;
    padding: 0.875rem 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 0.75rem 0;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    line-height: 1.5;
    border: 1px solid #2d3138;
}

.message-content code {
    background: rgba(45, 90, 71, 0.08);
    padding: 0.15rem 0.35rem;
    border-radius: 0.25rem;
    font-size: 0.85em;
    font-family: 'IBM Plex Mono', monospace;
    color: #2D5A47;
}

.message-content pre code {
    background: transparent;
    padding: 0;
    color: inherit;
}

.message-content ul, .message-content ol {
    padding-left: 1.5rem;
    margin: 0.5rem 0;
}

.message-content li {
    margin: 0.25rem 0;
}

.message-content p {
    margin: 0.5rem 0;
}

.message-content p:first-child {
    margin-top: 0;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.message-content blockquote {
    border-left: 3px solid #D4C9BC;
    padding-left: 1rem;
    margin: 0.75rem 0;
    color: #7A6A58;
    font-style: italic;
}

.message-content h1, .message-content h2, .message-content h3 {
    margin: 1rem 0 0.5rem;
    font-weight: 600;
    line-height: 1.3;
}

.message-content h1:first-child,
.message-content h2:first-child,
.message-content h3:first-child {
    margin-top: 0;
}

.message-content hr {
    border: none;
    border-top: 1px solid #E8E2DA;
    margin: 1rem 0;
}

.message-content a {
    color: #2D5A47;
    text-decoration: underline;
    text-underline-offset: 2px;
}

.message-content a:hover {
    color: #3D7A5F;
}

.message-content table {
    border-collapse: collapse;
    margin: 0.75rem 0;
    width: 100%;
    font-size: 0.85rem;
}

.message-content th, .message-content td {
    border: 1px solid #E8E2DA;
    padding: 0.5rem 0.75rem;
    text-align: left;
}

.message-content th {
    background: #F5F1EC;
    font-weight: 600;
}

/* User message markdown overrides */
.message-user .message-content code {
    background: rgba(255, 255, 255, 0.15);
    color: inherit;
}

.message-user .message-content pre {
    background: rgba(0, 0, 0, 0.2);
    border-color: rgba(255, 255, 255, 0.1);
}

.message-user .message-content a {
    color: #a8d5c2;
}

.message-user .message-content blockquote {
    border-color: rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.8);
}
</style>
{{end}}
