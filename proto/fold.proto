// ABOUTME: Protocol buffer definitions for agent-server communication.
// ABOUTME: Defines the bidirectional streaming protocol for fold control.

syntax = "proto3";
package fold;

import "google/protobuf/empty.proto";

// Agent connects to server, receives commands, sends results
service FoldControl {
  // Agent registration - bidirectional stream for lifecycle
  rpc AgentStream(stream AgentMessage) returns (stream ServerMessage);
}

// Messages from agent to server
message AgentMessage {
  oneof payload {
    RegisterAgent register = 1;
    MessageResponse response = 2;
    Heartbeat heartbeat = 3;
  }
}

// Git repository state (optional - agent may not be in a git repo)
message GitInfo {
  string branch = 1;
  string commit = 2;
  bool dirty = 3;
  string remote = 4;
  int32 ahead = 5;
  int32 behind = 6;
}

// Environment metadata sent during registration
message AgentMetadata {
  string working_directory = 1;
  GitInfo git = 2;
  string hostname = 3;
  string os = 4;
}

// Agent registration
message RegisterAgent {
  string agent_id = 1;           // Unique agent identifier
  string name = 2;               // Human-readable name
  repeated string capabilities = 3;  // What this agent can do
  AgentMetadata metadata = 4;    // Environment context
}

// Response to a message request
message MessageResponse {
  string request_id = 1;         // Correlates with SendMessage
  oneof event {
    string thinking = 2;
    string text = 3;
    ToolUse tool_use = 4;
    ToolResult tool_result = 5;
    Done done = 6;
    string error = 7;
    FileData file = 8;
    ToolApprovalRequest tool_approval_request = 9;
  }
}

// Request for tool approval before execution (agent → server)
message ToolApprovalRequest {
  string id = 1;           // Correlates with ToolUse.id
  string name = 2;         // Tool name
  string input_json = 3;   // Tool input for display
}

message ToolUse {
  string id = 1;
  string name = 2;
  string input_json = 3;
}

message ToolResult {
  string id = 1;
  string output = 2;
  bool is_error = 3;
}

message Done {
  string full_response = 1;
}

message FileData {
  string filename = 1;
  string mime_type = 2;
  bytes data = 3;
}

message Heartbeat {
  int64 timestamp_ms = 1;
}

// Messages from server to agent
message ServerMessage {
  oneof payload {
    Welcome welcome = 1;
    SendMessage send_message = 2;
    Shutdown shutdown = 3;
    ToolApprovalResponse tool_approval = 4;
    RegistrationError registration_error = 5;
  }
}

// Server rejects registration (e.g., agent_id already taken)
message RegistrationError {
  string reason = 1;              // Human-readable error message
  string suggested_id = 2;        // Optional: server-suggested alternative ID
}

// Response to tool approval request (server → agent)
message ToolApprovalResponse {
  string id = 1;           // Correlates with ToolApprovalRequest.id
  bool approved = 2;       // True = execute, False = skip
  bool approve_all = 3;    // If true, auto-approve remaining tools this request
}

// Server acknowledges registration
message Welcome {
  string server_id = 1;
  string agent_id = 2;  // Confirmed agent ID
}

// Server tells agent to process a message
message SendMessage {
  string request_id = 1;         // Unique request ID for correlation
  string thread_id = 2;          // Conversation thread
  string sender = 3;             // Who sent the message
  string content = 4;            // Message content
  repeated FileAttachment attachments = 5;
}

message FileAttachment {
  string filename = 1;
  string mime_type = 2;
  bytes data = 3;
}

// Server tells agent to shut down
message Shutdown {
  string reason = 1;
}

// AdminService provides administrative operations for managing the gateway.
// All methods require admin or owner role (enforced by RequireAdmin interceptor).
service AdminService {
  rpc ListBindings(ListBindingsRequest) returns (ListBindingsResponse);
  rpc CreateBinding(CreateBindingRequest) returns (Binding);
  rpc UpdateBinding(UpdateBindingRequest) returns (Binding);
  rpc DeleteBinding(DeleteBindingRequest) returns (DeleteBindingResponse);

  // Token management
  rpc CreateToken(CreateTokenRequest) returns (CreateTokenResponse);

  // Principal management
  rpc ListPrincipals(ListPrincipalsRequest) returns (ListPrincipalsResponse);
  rpc CreatePrincipal(CreatePrincipalRequest) returns (Principal);
  rpc DeletePrincipal(DeletePrincipalRequest) returns (DeletePrincipalResponse);
}

// Binding represents a channel-to-agent mapping for message routing
message Binding {
  string id = 1;
  string frontend = 2;
  string channel_id = 3;
  string agent_id = 4;
  string created_at = 5;  // ISO-8601
  optional string created_by = 6;
}

message ListBindingsRequest {
  optional string frontend = 1;
  optional string agent_id = 2;
}

message ListBindingsResponse {
  repeated Binding bindings = 1;
}

message CreateBindingRequest {
  string frontend = 1;
  string channel_id = 2;
  string agent_id = 3;
}

message UpdateBindingRequest {
  string id = 1;
  string agent_id = 2;
}

message DeleteBindingRequest {
  string id = 1;
}

message DeleteBindingResponse {
  // Empty response indicates success
}

// Token management messages
message CreateTokenRequest {
  string principal_id = 1;      // Principal to create token for
  int64 ttl_seconds = 2;        // Token lifetime in seconds (default: 30 days)
}

message CreateTokenResponse {
  string token = 1;             // The generated JWT token
  string expires_at = 2;        // ISO-8601 expiration timestamp
}

// Principal management messages
message Principal {
  string id = 1;
  string type = 2;              // "client", "agent", "pack"
  string display_name = 3;
  string status = 4;            // "pending", "approved", "online", "offline", "revoked"
  optional string pubkey_fp = 5; // SSH public key fingerprint (for agents)
  string created_at = 6;        // ISO-8601
  repeated string roles = 7;
}

message ListPrincipalsRequest {
  optional string type = 1;     // Filter by type
  optional string status = 2;   // Filter by status
}

message ListPrincipalsResponse {
  repeated Principal principals = 1;
}

message CreatePrincipalRequest {
  string type = 1;              // "client" or "agent"
  string display_name = 2;
  optional string pubkey = 3;   // Full SSH public key (for agents)
  optional string pubkey_fp = 4; // Or just the fingerprint
  repeated string roles = 5;    // Roles to assign (e.g., "member")
}

message DeletePrincipalRequest {
  string id = 1;
}

message DeletePrincipalResponse {
  // Empty response indicates success
}

// ClientService provides client-facing operations for interacting with agents.
// Requires authenticated principal (member role or higher).
service ClientService {
  rpc GetEvents(GetEventsRequest) returns (GetEventsResponse);
  rpc GetMe(google.protobuf.Empty) returns (MeResponse);
  rpc SendMessage(ClientSendMessageRequest) returns (ClientSendMessageResponse);
}

// ClientSendMessageRequest is the request for direct client message sending.
// The idempotency_key is required and must be unique per message to prevent duplicates.
message ClientSendMessageRequest {
  string conversation_key = 1;
  string content = 2;
  repeated FileAttachment attachments = 3;
  string idempotency_key = 4;  // required, 1-100 chars
}

// ClientSendMessageResponse is the response for direct client message sending.
message ClientSendMessageResponse {
  string status = 1;  // "accepted" or "duplicate"
  string message_id = 2;  // assigned message ID (empty for duplicates)
}

// MeResponse contains the authenticated principal's identity information
message MeResponse {
  string principal_id = 1;
  string principal_type = 2;
  string display_name = 3;
  string status = 4;
  repeated string roles = 5;
  optional string member_id = 6;
  optional string member_display_name = 7;
}

// Event represents a ledger event in conversation history
message Event {
  string id = 1;
  string conversation_key = 2;
  string direction = 3;           // "inbound_to_agent" or "outbound_from_agent"
  string author = 4;
  string timestamp = 5;           // ISO-8601
  string type = 6;                // "message", "tool_call", "tool_result", "system", "error"
  optional string text = 7;
  optional string raw_transport = 8;
  optional string raw_payload_ref = 9;
  optional string actor_principal_id = 10;
  optional string actor_member_id = 11;
}

message GetEventsRequest {
  string conversation_key = 1;
  optional string since = 2;      // ISO-8601
  optional string until = 3;      // ISO-8601
  optional int32 limit = 4;       // 1-500
  optional string cursor = 5;
}

message GetEventsResponse {
  repeated Event events = 1;
  optional string next_cursor = 2;
  bool has_more = 3;
}
